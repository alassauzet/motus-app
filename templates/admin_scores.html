<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Admin – Édition des scores</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        body {
            background-color: #0f172a;
            color: #e5e7eb;
        }

        header a {
            color: #cbd5e1;
            text-decoration: none;
        }

        header a:hover {
            text-decoration: underline;
        }

        .flash-message {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background-color: #22c55e;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1050;
            font-weight: bold;
            transition: opacity 0.3s;
        }

        .btn-icon i {
            font-size: 1rem;
        }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">

<div id="flash-message" class="flash-message"></div>

<header class="d-flex justify-content-between align-items-center p-3 mb-4 border-bottom border-secondary">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" height="36">
    <div>
        <a href="{{ url_for('dashboard') }}" class="me-3">Dashboard</a>
        <a href="{{ url_for('logout') }}">Déconnexion</a>
    </div>
</header>

<div class="container d-flex flex-column align-items-center">

    <h1 class="mb-4 text-center">Administration des scores</h1>

    <!-- Toolbar -->
    <div class="mb-3 w-100 d-flex justify-content-center">
        <button class="btn btn-secondary btn-icon" onclick="copyCSV()">
            <i class="bi bi-clipboard"></i> Copier CSV
        </button>
    </div>

    <!-- Add form -->
    <h3 class="mb-3 text-center">Ajouter un score</h3>
    <form method="POST" class="row g-2 mb-4 justify-content-center">
        <input type="hidden" name="action" value="add">
        <div class="col-12 col-md-auto">
            <input type="date" name="date" class="form-control" value="{{ today }}" required>
        </div>
        <div class="col-12 col-md-auto">
            <input type="text" name="username" class="form-control" placeholder="Utilisateur" required>
        </div>
        <div class="col-12 col-md-auto">
            <input type="number" name="attempts" class="form-control" min="1" placeholder="Essais" required>
        </div>
        <div class="col-12 col-md-auto">
            <button class="btn btn-success btn-icon w-100">
                <i class="bi bi-plus-lg"></i> Ajouter
            </button>
        </div>
    </form>

    <!-- Table responsive + centered -->
    <div class="table-responsive w-100">
        <table id="scores-table" class="table table-dark table-striped table-hover text-center align-middle">
            <thead class="table-secondary text-dark">
            <tr>
                <th>Date</th>
                <th>Utilisateur</th>
                <th>Essais</th>
                <th>Points</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for s in scores %}
                <tr>
                    <form method="POST" class="d-flex gap-2 justify-content-center align-items-center flex-wrap">
                        <td>
                            <input type="date" name="date" class="form-control form-control-sm"
                                   value="{{ s.date.strftime('%Y-%m-%d') }}">
                        </td>
                        <td class="align-middle">{{ s.username }}</td>
                        <td>
                            <input type="number" name="attempts" class="form-control form-control-sm"
                                   value="{{ s.attempts }}">
                        </td>
                        <td>
                            <input type="number" name="points" class="form-control form-control-sm"
                                   value="{{ s.points }}" min="0">
                        </td>
                        <td class="d-flex justify-content-center gap-1 flex-wrap">
                            <input type="hidden" name="index" value="{{ s.index }}">
                            <button class="btn btn-primary btn-sm btn-icon" name="action" value="edit"
                                    title="Sauvegarder">
                                <i class="bi bi-save"></i>
                            </button>
                            <button class="btn btn-danger btn-sm btn-icon" name="action" value="delete"
                                    title="Supprimer"
                                    onclick="return confirm('Supprimer cette ligne ?')">
                                <i class="bi bi-trash"></i>
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm btn-icon" title="Copier"
                                    onclick="copyRow(this)">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </td>
                    </form>
                </tr>
            {% else %}
                <tr>
                    <td colspan="5">Aucun score</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <nav aria-label="Pagination" class="mt-3">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if page == 1 %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('admin_scores.manage_scores', page=page-1) }}">Précédent</a>
            </li>
            {% for p in range(1, total_pages+1) %}
                <li class="page-item {% if p == page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('admin_scores.manage_scores', page=p) }}">{{ p }}</a>
                </li>
            {% endfor %}
            <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('admin_scores.manage_scores', page=page+1) }}">Suivant</a>
            </li>
        </ul>
    </nav>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function showFlash(message, duration = 2000) {
        const flash = document.getElementById("flash-message");
        flash.textContent = message;
        flash.style.opacity = '1';
        flash.style.display = "block";
        setTimeout(() => {
            flash.style.opacity = '0';
            setTimeout(() => flash.style.display = 'none', 300);
        }, duration);
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(
            () => showFlash("Copié dans le presse-papiers ✅"),
            () => showFlash("Erreur lors de la copie ❌")
        );
    }

    function copyRow(btn) {
        const row = btn.closest("tr");
        const values = Array.from(row.querySelectorAll("td"))
            .slice(0, 4)
            .map(td => td.innerText.trim())
            .join("\t");
        copyToClipboard(values);
    }

    function copyCSV() {
        const rows = document.querySelectorAll("#scores-table tbody tr");
        const headers = ["date", "username", "attempts", "points"];
        let csv = headers.join(",") + "\n";

        rows.forEach(row => {
            const tds = row.querySelectorAll("td");
            const getCellValue = (td, inputName) => {
                const input = td.querySelector(`input[name="${inputName}"]`);
                return input ? input.value.trim() : td.innerText.trim();
            };
            const rowValues = [
                getCellValue(tds[0], "date"),
                getCellValue(tds[1], null),
                getCellValue(tds[2], "attempts"),
                getCellValue(tds[3], null)
            ];
            csv += rowValues.join(",") + "\n";
        });
        copyToClipboard(csv);
    }
</script>

</body>
</html>
